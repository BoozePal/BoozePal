<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	template="/templates/masterLayout.xhtml">
	<ui:define name="head-extra">
		<style>
#map {
	height: 400px;
	width: 100%;
}
</style>
		<script
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCa4dOjlTdQeTmLQhBqu4h-khzsREWwqsw" />
		<script>
		var parsedUsers;
		var infowindow = new google.maps.InfoWindow();
		function initMap() {
			
			var usersInMap = '${mapBean.onlineUsers}';
			parsedUsers = JSON.parse(usersInMap);
	        var map = new google.maps.Map(document.getElementById('map'), {
	          center: {lat: -34.397, lng: 150.644},
	          zoom: 13
	        });

	        function createMarker(pos,text) {
				var marker = new google.maps.Marker({
						position: pos,
						map: map
				 });
				 google.maps.event.addListener(marker, 'click', function() {
					    infowindow.close();
					    infowindow.setContent(text);
					    infowindow.open(map,marker);
			     });
			}
	        
	        if (navigator.geolocation) {
	          navigator.geolocation.getCurrentPosition(function(position) {
	            var pos = {
	              lat: position.coords.latitude,
	              lng: position.coords.longitude
	            };

	            var selfInfoWindow = new google.maps.InfoWindow({
	                content: '${out.yourPosition}'
	              });
	            var marker = new google.maps.Marker({
	                position: pos,
	                map: map
	              });
	            marker.addListener('click', function() {
	            	selfInfoWindow.open(map, marker);
	              });
	            map.setCenter(pos);
	            for (var i = 0; i &lt; parsedUsers.length; i++) {
	            	var userPos = {lat: parsedUsers[i].latitude, lng: parsedUsers[i].altitude};
	            	createMarker(userPos, parsedUsers[i].fullName);
				}
	          }, function() {
	            handleLocationError(true, infoWindow, map.getCenter());
	          });
	        } else {
	        	geocoder.geocode( { 'address': 'Debrecen,Hungary' }, function(results, status) {
	        	    if (status == google.maps.GeocoderStatus.OK) {
	        	        newAddress = results[0].geometry.location;
	        	        var latlng = new google.maps.LatLng(parseFloat(newAddress.lat()),parseFloat(newAddress.lng()));
	        	        gmarkers.push( new google.maps.Marker({
	    	                position: latlng,
	    	                map: map
	    	              }));
	        	    }
	        });
	      }
		
	      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
	        infoWindow.setPosition(pos);
	        infoWindow.setContent(browserHasGeolocation ?
	                              'Error: The Geolocation service failed.' :
	                              'Error: Your browser doesn\'t support geolocation.');
	      }
		}
      	google.maps.event.addDomListener(window, 'load', initMap);
    </script>
	</ui:define>
	<ui:define name="content">
		<h3>
			<p:outputLabel value="${out.onlineUsers}" />
		</h3>
		<div id="map"></div>
	</ui:define>
</ui:composition>
